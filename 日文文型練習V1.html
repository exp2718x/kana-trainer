<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>日語文型練習</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root{
            --bg:#0f172a;
            --card-even:#1e293b;
            --card-odd:#2c3a4e;
            --modal-bg:#1e293b;
            --muted:#94a3b8;
            --bd:#334155;
            --accent:#22d3ee;
            --ok:#10b981;
            --btn-bg: #4CAF50;
            --text-light:#f1f5f9;
            --text-mid:#cbd5e1;
            --text-dark:#e5e7eb;
        }
        *{box-sizing:border-box}
        body{
            font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
            background:var(--bg);
            color:var(--text-light);
            margin:0;
            padding: 20px;
        }
        header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:12px;
            border-bottom:1px solid var(--bd);
        }
        h1{
            text-align:center;
            font-size:24px;
            color: var(--accent);
            margin:0;
            flex-grow:1;
        }
        .container{
            max-width: 800px;
            margin: 0 auto;
        }
        .vocab-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .vocab-item {
            border: 1px solid var(--bd);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
            /* 移除多餘行高設定 */
        }
        .vocab-item.even {
            background: var(--card-even);
        }
        .vocab-item.odd {
            background: var(--card-odd);
        }
        .vocab-item:hover {
            background: #2b3a4f;
        }
        .vocab-reading {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-mid);
            margin: 0 0 0.5rem 0; /* 增加底部間距 */
        }
        .vocab-kanji {
            font-size: 1.1rem;
            color: var(--text-dark);
            margin: 0 0 0.5rem 0; /* 增加底部間距 */
        }
        .vocab-zh {
            font-size: 1rem;
            color: var(--text-dark); /* 將顏色改為與日文漢字相同 */
            margin: 0;
        }
        .loading {
            text-align: center;
            color: var(--muted);
            margin-top: 50px;
        }
        .loading::after {
            content: '載入中...';
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--modal-bg);
            padding: 20px;
            border-radius: 12px;
            max-width: 560px;
            max-height: 80vh;
            overflow: auto;
        }
        .modal h2 {
            margin-top: 0;
            font-size: 18px;
            text-align: center;
        }
        .btn {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn-header {
            background: var(--card-even);
            color: var(--text-light);
            border: 1px solid var(--bd);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }
        .setting-item {
            margin-bottom: 20px;
        }
        .setting-item label {
            color: var(--muted);
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .setting-item input[type="file"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--bd);
            background: var(--card-even);
            color: var(--text-light);
            cursor: pointer;
        }
        #closeModal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 24px;
            cursor: pointer;
        }
        .lesson-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .lesson-chip {
            padding: 8px 12px;
            border: 1px solid var(--bd);
            border-radius: 999px;
            cursor: pointer;
            background: var(--card-even);
            color: var(--text-light);
            transition: background 0.2s;
        }
        .lesson-chip:hover {
            background: #2b3a4f;
        }
        .lesson-chip.selected {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        #confirmBtn {
            margin-top: 20px;
            display: block;
            width: 100%;
            background: var(--ok);
            color: var(--text-light);
            text-align: center;
            border: none;
        }
        .speed-options {
            display: flex;
            justify-content: space-around;
            gap: 12px;
        }
        .speed-label {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--bd);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .speed-label:hover {
            background: #2b3a4f;
        }
        .speed-input:checked + .speed-label {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }
        .speed-input {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>日語文型練習</h1>
        <button class="btn-header" id="settingsBtn">
            設定
        </button>
    </header>
    <div class="container">
        <div id="loading" class="loading"></div>
        <div id="vocabList" class="vocab-list"></div>
    </div>

    <!-- 設定彈出視窗 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <button id="closeModal">&times;</button>
            <h2>設定</h2>
            
            <div class="setting-item">
                <label for="lessonSelect">選擇課程（可多選）：</label>
                <div id="lessonOptions" class="lesson-options"></div>
            </div>

            <div class="setting-item">
                <label>語音速度：</label>
                <div class="speed-options">
                    <input type="radio" id="speedSlow" name="speed" class="speed-input" data-rate="0.55">
                    <label for="speedSlow" class="speed-label">慢</label>
                    <input type="radio" id="speedSlower" name="speed" class="speed-input" data-rate="0.75" checked>
                    <label for="speedSlower" class="speed-label">中慢</label>
                    <input type="radio" id="speedNormal" name="speed" class="speed-input" data-rate="0.95">
                    <label for="speedNormal" class="speed-label">中</label>
                    <input type="radio" id="speedFast" name="speed" class="speed-input" data-rate="1.15">
                    <label for="speedFast" class="speed-label">快</label>
                </div>
            </div>
            
            <div class="setting-item">
                <label for="fileInput">或上傳自己的 Excel 檔案：</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls">
            </div>

            <button id="confirmBtn" class="btn">確定</button>
        </div>
    </div>

    <!-- 訊息彈出視窗 -->
    <div id="messageModal" class="modal">
        <div class="modal-content" style="max-width:300px; text-align:center;">
            <p id="messageContent"></p>
            <button class="btn" onclick="closeMessageBox()">確定</button>
        </div>
    </div>

    <script>
        const VOCAB_FILE_URL = "https://raw.githubusercontent.com/exp2718x/kana-trainer/refs/heads/main/00-%E6%97%A5%E8%AA%9E%E6%96%87%E5%9E%8B%E6%95%B4%E7%90%86.xlsx";
        const vocabListDiv = document.getElementById('vocabList');
        const loadingDiv = document.getElementById('loading');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModalBtn = document.getElementById('closeModal');
        const fileInput = document.getElementById('fileInput');
        const lessonOptionsDiv = document.getElementById('lessonOptions');
        const confirmBtn = document.getElementById('confirmBtn');
        const messageModal = document.getElementById('messageModal');
        const messageContent = document.getElementById('messageContent');

        let allVocabData = [];
        let courses = [];
        let selectedCourses = [];
        let currentSpeechRate = 1.0;

        // 載入 XLSX 檔案並解析
        async function loadVocab(url) {
            loadingDiv.style.display = 'block';
            vocabListDiv.innerHTML = '';
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: ["reading", "kanji", "zh"] });

                allVocabData = [];
                courses = [{ name: '全部', index: 'all' }]; // 新增「全部」選項
                
                let currentCourseIndex = 0;

                // 遍歷原始資料，分離課程與文型
                rawData.forEach((row, index) => {
                    if (row.reading && row.reading.startsWith('**')) {
                        // 這是註釋行，忽略
                    } else if (row.reading && row.reading.startsWith('*')) {
                        // 這是課程行，儲存課程名稱
                        courses.push({ name: row.reading.substring(1).trim(), index: currentCourseIndex });
                        currentCourseIndex++;
                    } else if (row.reading || row.kanji || row.zh) {
                        // 這是文型資料
                        allVocabData.push({ ...row, courseIndex: currentCourseIndex - 1 });
                    }
                });
                
                // 預設選取「全部」選項
                selectedCourses = ['all'];
                renderLessonOptions();
                renderVocab(allVocabData);

            } catch (error) {
                console.error("載入文型資料時發生錯誤:", error);
                loadingDiv.textContent = '載入失敗，請檢查網路連線或檔案格式。';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        // 渲染課程選項
        function renderLessonOptions() {
            lessonOptionsDiv.innerHTML = '';
            courses.forEach(course => {
                const chip = document.createElement('div');
                chip.className = 'lesson-chip';
                chip.textContent = course.name;
                chip.dataset.index = course.index;
                
                // 設定選取狀態
                if (selectedCourses.includes(course.index)) {
                    chip.classList.add('selected');
                }

                chip.addEventListener('click', () => {
                    toggleCourseSelection(course.index);
                });
                lessonOptionsDiv.appendChild(chip);
            });
        }

        // 切換課程選取狀態
        function toggleCourseSelection(index) {
            const allChip = lessonOptionsDiv.querySelector(`[data-index="all"]`);
            
            if (index === 'all') {
                // 如果點擊的是「全部」，則只選取「全部」
                selectedCourses = ['all'];
                document.querySelectorAll('.lesson-chip').forEach(chip => {
                    chip.classList.remove('selected');
                });
                allChip.classList.add('selected');
            } else {
                // 如果點擊的是其他課程
                const chip = lessonOptionsDiv.querySelector(`[data-index="${index}"]`);
                
                // 如果「全部」是選取的，先取消選取它
                if (selectedCourses.includes('all')) {
                    selectedCourses = selectedCourses.filter(i => i !== 'all');
                    allChip.classList.remove('selected');
                }

                // 切換目前點擊的課程
                if (selectedCourses.includes(index)) {
                    selectedCourses = selectedCourses.filter(i => i !== index);
                    chip.classList.remove('selected');
                } else {
                    selectedCourses.push(index);
                    chip.classList.add('selected');
                }

                // 如果所有課程都取消選取了，就回到「全部」
                if (selectedCourses.length === 0) {
                    selectedCourses = ['all'];
                    allChip.classList.add('selected');
                }
            }
        }
        
        // 渲染文型列表
        function renderVocab(vocab) {
            vocabListDiv.innerHTML = '';
            
            let filteredVocab;
            // 判斷是否選取「全部」來決定是否過濾
            if (selectedCourses.includes('all')) {
                filteredVocab = vocab;
            } else {
                filteredVocab = vocab.filter(item => selectedCourses.includes(item.courseIndex));
            }

            if (filteredVocab.length === 0) {
                vocabListDiv.innerHTML = '<p style="text-align: center; color: var(--muted);">沒有找到文型資料。</p>';
                return;
            }

            filteredVocab.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `vocab-item ${index % 2 === 0 ? 'even' : 'odd'}`;
                
                const readingP = document.createElement('p');
                readingP.className = 'vocab-reading';
                readingP.textContent = item.reading || '';
                
                const kanjiP = document.createElement('p');
                kanjiP.className = 'vocab-kanji';
                kanjiP.textContent = item.kanji || '';
                
                const zhP = document.createElement('p');
                zhP.className = 'vocab-zh';
                zhP.textContent = item.zh || '';

                itemDiv.appendChild(readingP);
                itemDiv.appendChild(kanjiP);
                itemDiv.appendChild(zhP);
                
                // 點擊發音功能
                itemDiv.addEventListener('click', () => {
                    if ('speechSynthesis' in window) {
                        // 語音破音處理：先發一個無聲字元喚醒語音引擎
                        window.speechSynthesis.cancel(); // 停止先前的語音
                        const silentUtterance = new SpeechSynthesisUtterance(" ");
                        silentUtterance.volume = 0; // 設為靜音
                        silentUtterance.rate = 1.0;
                        
                        // 靜音播放結束後，再播放主要語音
                        silentUtterance.onend = () => {
                            const utterance = new SpeechSynthesisUtterance(item.reading);
                            utterance.lang = 'ja-JP';
                            utterance.rate = currentSpeechRate;
                            window.speechSynthesis.speak(utterance);
                        };

                        window.speechSynthesis.speak(silentUtterance);
                    } else {
                        showMessageBox('您的瀏覽器不支援語音合成功能。');
                    }
                });

                vocabListDiv.appendChild(itemDiv);
            });
        }
        
        // 處理檔案上傳
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: ["reading", "kanji", "zh"] });

                allVocabData = [];
                courses = [{ name: '全部', index: 'all' }];
                let currentCourseIndex = 0;

                rawData.forEach((row, index) => {
                    if (row.reading && row.reading.startsWith('**')) {
                        // 這是註釋行，忽略
                    } else if (row.reading && row.reading.startsWith('*')) {
                        // 這是課程行，儲存課程名稱
                        courses.push({ name: row.reading.substring(1).trim(), index: currentCourseIndex });
                        currentCourseIndex++;
                    } else if (row.reading || row.kanji || row.zh) {
                        // 這是文型資料
                        allVocabData.push({ ...row, courseIndex: currentCourseIndex - 1 });
                    }
                });

                // 預設選取「全部」選項
                selectedCourses = ['all'];
                renderLessonOptions();
                
                // 上傳後自動重新渲染
                updateVocabList();
            };
            reader.readAsArrayBuffer(file);
        });
        
        // 根據選擇的課程更新文型列表
        function updateVocabList() {
            renderVocab(allVocabData);
            settingsModal.style.display = 'none'; // 載入後關閉視窗
        }

        // 顯示/隱藏彈出視窗
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });

        closeModalBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        confirmBtn.addEventListener('click', () => {
            updateVocabList();
        });

        // 監聽語速選擇
        const speedRadios = document.querySelectorAll('.speed-input');
        speedRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentSpeechRate = parseFloat(e.target.dataset.rate);
            });
        });

        // 顯示自定義訊息方塊
        function showMessageBox(message) {
            messageContent.textContent = message;
            messageModal.style.display = 'flex';
        }

        // 關閉自定義訊息方塊
        function closeMessageBox() {
            messageModal.style.display = 'none';
        }

        // 點擊視窗外關閉視窗
        window.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (event.target === messageModal) {
                closeMessageBox();
            }
        });

        // 頁面載入時自動執行
        document.addEventListener('DOMContentLoaded', () => {
            loadVocab(VOCAB_FILE_URL);
        });
    </script>
</body>
</html>
