<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日文五十音練習｜Hiragana & Katakana Trainer</title>
  <style>
    body { font-family: sans-serif; background:#0f172a; color:#eee; margin:0; padding:0; }
    .container { max-width: 900px; margin:0 auto; padding:20px; }
    .panel { background:#1e293b; border-radius:10px; padding:16px; margin-bottom:20px; }
    h1 { margin:0 0 10px; }
    .prompt { font-size:64px; text-align:center; margin:20px 0; }
    .btn { background:#22d3ee; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; margin:4px; }
    .btn.secondary { background:#a78bfa; }
    .btn.ghost { background:#334155; color:#fff; }
    .input { width:100%; padding:10px; font-size:18px; border-radius:8px; border:none; margin:10px 0; }
    .feedback { font-weight:bold; margin-top:10px; }
    .ok { color:#34d399; }
    .err { color:#f87171; }
    .choices { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; }
    .choice-btn { background:#475569; border:none; border-radius:8px; padding:10px; font-size:20px; cursor:pointer; }
    .choice-btn:hover { background:#64748b; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    label { display:flex; align-items:center; gap:4px; }
    #history { 
      margin-top:20px; 
      background:#1e293b; 
      padding:10px; 
      border-radius:10px; 
      font-size:16px; 
      display:flex; 
      flex-wrap:wrap; 
      gap:8px; 
    }
    #history div { 
      background:#334155; 
      padding:4px 8px; 
      border-radius:6px; 
      white-space:nowrap; 
    }
    #history div.err { color:#f87171; }
    #history div.ok { color:#34d399; }
    #stats { margin-top:10px; font-size:16px; color:#fcd34d; }
  </style>
</head>
<body>
<div class="container">
  <h1>日文五十音練習 <span style="font-size:14px; color:#94a3b8;">帶發音 & 選擇題</span></h1>

  <div class="panel">
    <div class="row">
      <label><input type="radio" name="direction" value="kana2roma" checked> 假名→羅馬字</label>
      <label><input type="radio" name="direction" value="roma2kana"> 羅馬字→假名</label>
      <label><input type="radio" name="mode" value="input" checked> 輸入模式</label>
      <label><input type="radio" name="mode" value="choice"> 選擇題模式</label>
    </div>
    <div class="row">
      <label><input type="checkbox" name="set" value="hira" checked> 平假名</label>
      <label><input type="checkbox" name="set" value="kata" checked> 片假名</label>
      <label><input type="checkbox" name="set" value="youon"> 含拗音</label>
      <label><input type="checkbox" name="set" value="words"> 多字組合（含促音）</label>
    </div>
    <div class="prompt" id="q">—</div>
    <div class="row" style="justify-content:center;">
      <button class="btn" id="btn-speak">🔊 發音</button>
      <select id="speed-select" class="btn ghost">
        <option value="0.3">慢速</option>
        <option value="0.5" selected>正常</option>
        <option value="0.9">快速</option>
      </select>
      <label style="color:#ccc;">自訂速度 <input id="custom-speed" type="number" step="0.1" min="0.1" max="2" value="0.5" style="width:60px; padding:4px; border-radius:6px; border:none;"> </label>
    </div>
    <div id="input-mode">
      <input class="input" id="answer" placeholder="輸入答案，Enter 送出">
      <button class="btn secondary" id="btn-submit">送出</button>
    </div>
    <div id="choice-mode" style="display:none;">
      <div class="choices" id="choices"></div>
    </div>
    <div class="feedback" id="feedback"> </div>
  </div>

  <button class="btn ghost" id="btn-clear-history">清除歷史紀錄</button>
  <div id="stats">正確 0 / 總題數 0 (0%)</div>
  <div id="history"></div>
</div>

<script>
// === 基礎假名（多拼音） ===
const BASIC = [
  ['あ','ア',['a']], ['い','イ',['i']], ['う','ウ',['u']], ['え','エ',['e']], ['お','オ',['o']],
  ['か','カ',['ka']], ['き','キ',['ki']], ['く','ク',['ku']], ['け','ケ',['ke']], ['こ','コ',['ko']],
  ['さ','サ',['sa']], ['し','シ',['shi','si']], ['す','ス',['su']], ['せ','セ',['se']], ['そ','ソ',['so']],
  ['た','タ',['ta']], ['ち','チ',['chi','ti']], ['つ','ツ',['tsu','tu']], ['て','テ',['te']], ['と','ト',['to']],
  ['な','ナ',['na']], ['に','ニ',['ni']], ['ぬ','ヌ',['nu']], ['ね','ネ',['ne']], ['の','ノ',['no']],
  ['は','ハ',['ha']], ['ひ','ヒ',['hi']], ['ふ','フ',['fu','hu']], ['へ','ヘ',['he']], ['ほ','ホ',['ho']],
  ['ま','マ',['ma']], ['み','ミ',['mi']], ['む','ム',['mu']], ['め','メ',['me']], ['も','モ',['mo']],
  ['や','ヤ',['ya']], ['ゆ','ユ',['yu']], ['よ','ヨ',['yo']],
  ['ら','ラ',['ra']], ['り','リ',['ri']], ['る','ル',['ru']], ['れ','レ',['re']], ['ろ','ロ',['ro']],
  ['わ','ワ',['wa']], ['を','ヲ',['wo','o']], ['ん','ン',['n','nn']]
];

// === 拗音（多拼音） ===
const YOUON = [
  ['きゃ','キャ',['kya']], ['きゅ','キュ',['kyu']], ['きょ','キョ',['kyo']],
  ['しゃ','シャ',['sha','sya']], ['しゅ','シュ',['shu','syu']], ['しょ','ショ',['sho','syo']],
  ['ちゃ','チャ',['cha','tya']], ['ちゅ','チュ',['chu','tyu']], ['ちょ','チョ',['cho','tyo']],
  ['にゃ','ニャ',['nya']], ['にゅ','ニュ',['nyu']], ['にょ','ニョ',['nyo']],
  ['ひゃ','ヒャ',['hya']], ['ひゅ','ヒュ',['hyu']], ['ひょ','ヒョ',['hyo']],
  ['みゃ','ミャ',['mya']], ['みゅ','ミュ',['myu']], ['みょ','ミョ',['myo']],
  ['りゃ','リャ',['rya']], ['りゅ','リュ',['ryu']], ['りょ','リョ',['ryo']]
];

// === 單詞（多字組合，示例，可自行擴充） ===
const WORDS = [
  ['いった','イッタ'],
  ['がっこう','ガッコウ'],
  ['まって','マッテ'],
  ['きっぷ','キップ'],
  ['やっぱり','ヤッパリ'],
  ['けっこん','ケッコン'],
  ['ざっし','ザッシ'],
  ['きょう','キョウ'],
  ['きゃく','キャク'],
  ['しゅっぱつ','シュッパツ'],
];

// 供解析用：平假名/片假名 -> 基本羅馬字（不含拗音/促音邏輯）
const BASE_ROMA = {
  // 清音
  'あ':'a','い':'i','う':'u','え':'e','お':'o','か':'ka','き':'ki','く':'ku','け':'ke','こ':'ko',
  'さ':'sa','し':'shi','す':'su','せ':'se','そ':'so','た':'ta','ち':'chi','つ':'tsu','て':'te','と':'to',
  'な':'na','に':'ni','ぬ':'nu','ね':'ne','の':'no','は':'ha','ひ':'hi','ふ':'fu','へ':'he','ほ':'ho',
  'ま':'ma','み':'mi','む':'mu','め':'me','も':'mo','や':'ya','ゆ':'yu','よ':'yo','ら':'ra','り':'ri','る':'ru','れ':'re','ろ':'ro','わ':'wa','を':'wo','ん':'n',
  // 濁音/半濁音
  'が':'ga','ぎ':'gi','ぐ':'gu','げ':'ge','ご':'go','ざ':'za','じ':'ji','ず':'zu','ぜ':'ze','ぞ':'zo',
  'だ':'da','ぢ':'ji','づ':'zu','で':'de','ど':'do','ば':'ba','び':'bi','ぶ':'bu','べ':'be','ぼ':'bo','ぱ':'pa','ぴ':'pi','ぷ':'pu','ぺ':'pe','ぽ':'po',
  // 片假名對應
  'ア':'a','イ':'i','ウ':'u','エ':'e','オ':'o','カ':'ka','キ':'ki','ク':'ku','ケ':'ke','コ':'ko',
  'サ':'sa','シ':'shi','ス':'su','セ':'se','ソ':'so','タ':'ta','チ':'chi','ツ':'tsu','テ':'te','ト':'to',
  'ナ':'na','ニ':'ni','ヌ':'nu','ネ':'ne','ノ':'no','ハ':'ha','ヒ':'hi','フ':'fu','ヘ':'he','ホ':'ho',
  'マ':'ma','ミ':'mi','ム':'mu','メ':'me','モ':'mo','ヤ':'ya','ユ':'yu','ヨ':'yo','ラ':'ra','リ':'ri','ル':'ru','レ':'re','ロ':'ro','ワ':'wa','ヲ':'wo','ン':'n',
  'ガ':'ga','ギ':'gi','グ':'gu','ゲ':'ge','ゴ':'go','ザ':'za','ジ':'ji','ズ':'zu','ゼ':'ze','ゾ':'zo',
  'ダ':'da','ヂ':'ji','ヅ':'zu','デ':'de','ド':'do','バ':'ba','ビ':'bi','ブ':'bu','ベ':'be','ボ':'bo','パ':'pa','ピ':'pi','プ':'pu','ペ':'pe','ポ':'po'
};

const SMALL_Y = new Set(['ゃ','ゅ','ょ','ャ','ュ','ョ']);
const SMALL_V = new Set(['ぁ','ぃ','ぅ','ぇ','ぉ','ァ','ィ','ゥ','ェ','ォ']);

const state = {
  pool: [],
  direction:'kana2roma',
  mode:'input',
  current:null,
  rate:0.5,
  total:0,
  correct:0
};

function rebuildPool(){
  const hira = document.querySelector("input[value='hira']").checked;
  const kata = document.querySelector("input[value='kata']").checked;
  const youon = document.querySelector("input[value='youon']").checked;
  const words = document.querySelector("input[value='words']").checked;

  let pool = [];
  // 單字（五十音 + 拗音）
  let base = BASIC;
  if(youon) base = BASIC.concat(YOUON);
  const singlePool = base.map(([h,k,r])=>({hira:h,kata:k,roma:r})).filter(it=> (hira && it.hira) || (kata && it.kata));

  // 多字組合
  let wordPool = [];
  if(words){
    wordPool = WORDS.map(([h,k])=>{
      const romaMain = generateRoma(h); // 以平假名版本生成主羅馬字
      const variants = expandRomajiVariants(romaMain);
      return {hira:h,kata:k,roma:[...variants]};
    }).filter(it=> (hira && it.hira) || (kata && it.kata));
  }

  pool = words ? singlePool.concat(wordPool) : singlePool;
  state.pool = pool;
}

function updateStats(){
  const percent = state.total>0? Math.round(state.correct/state.total*100):0;
  document.getElementById('stats').textContent = `正確 ${state.correct} / 總題數 ${state.total} (${percent}%)`;
}

function nextQuestion(){
  if(state.pool.length===0){ rebuildPool(); }
  const it = state.pool[Math.floor(Math.random()*state.pool.length)];
  state.current = it;
  const showKana = (state.direction==='kana2roma');

  if(showKana){
    const hira = document.querySelector("input[value='hira']").checked;
    const kata = document.querySelector("input[value='kata']").checked;

    if(hira && kata){
      document.getElementById('q').textContent = Math.random()<0.5 ? it.hira : it.kata;
    }else if(hira){
      document.getElementById('q').textContent = it.hira;
    }else if(kata){
      document.getElementById('q').textContent = it.kata;
    }else{
      document.getElementById('q').textContent = '（請勾選平假名或片假名）';
    }
  } else {
    // 顯示第一個可接受拼音
    document.getElementById('q').textContent = Array.isArray(it.roma) ? it.roma[0] : it.roma;
  }

  document.getElementById('feedback').textContent = '';
  document.getElementById('answer').value = '';

  if(state.mode==='choice'){
    renderChoices(it);
  }
}


function checkAnswer(ans){
  state.total++;
  const showKana = (state.direction==='kana2roma');
  let correct;
  if(showKana){
    const input = ans.trim().toLowerCase();
    correct = state.current.roma.some(r => r === input);
  } else {
    correct = (ans.trim()===state.current.hira || ans.trim()===state.current.kata);
  }

  if(correct){
    state.correct++;
    document.getElementById('feedback').innerHTML = `<span class="ok">✔ 正確</span>`;
    speakKana();
    document.getElementById('answer').value = '';
    addHistory(state.current, true);
    setTimeout(nextQuestion,1200);
  } else {
    document.getElementById('feedback').innerHTML = `<span class="err">✘ 錯誤，再試一次</span>`;
    playBeep();
    addHistory(state.current, false, ans.trim());
    document.getElementById('answer').value = ''; // 答錯也清空
  }
  updateStats();
}


function renderChoices(it){
  const showKana = (state.direction==='kana2roma');
  const correct = showKana? (Array.isArray(it.roma)? it.roma[0] : it.roma) : it.hira;
  let options = new Set([correct]);
  while(options.size<4){
    const rnd = state.pool[Math.floor(Math.random()*state.pool.length)];
    const opt = showKana? (Array.isArray(rnd.roma)? rnd.roma[0] : rnd.roma) : rnd.hira;
    options.add(opt);
  }
  const arr = Array.from(options).sort(()=>Math.random()-0.5);
  const box = document.getElementById('choices');
  box.innerHTML = '';
  arr.forEach(opt=>{
    const b = document.createElement('button');
    b.textContent = opt;
    b.className = 'choice-btn';
    b.onclick=()=>checkAnswer(opt);
    box.appendChild(b);
  });
}

function speakKana(){
  if(!state.current) return;
  const showKana = (state.direction==='kana2roma');
  // 朗讀畫面上顯示的文字，確保多字也會唸
  const displayText = document.getElementById('q').textContent;
  const utter = new SpeechSynthesisUtterance(displayText + 'ー');
  utter.lang = 'ja-JP';
  utter.rate = state.rate;
  utter.pitch = 1.0;
  utter.volume = 1.0;
  speechSynthesis.speak(utter);
}

function playBeep(){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 440;
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  gain.gain.setValueAtTime(0.2, ctx.currentTime);
  osc.stop(ctx.currentTime+0.3);
}

function addHistory(item, correct, userInput=""){
  const h = document.getElementById('history');
  const div = document.createElement('div');

  if(correct){
    div.innerHTML = `✔ <span style="color:#34d399">${item.hira}/${item.kata} → ${item.roma[0]}</span>`;
  } else {
    div.innerHTML = `
      ${item.hira}/${item.kata} → 
      <span style="color:#f87171;text-decoration:line-through;">${userInput}</span>, 
      <span style="color:#34d399;">✔ ${item.roma[0]}</span>`;
  }

  h.prepend(div); // 最新在最前
}




// === 假名解析與羅馬字生成（拗音 + 促音 + 長音） ===
function generateRoma(kanaStr){
  // 將字串切成單位（處理拗音）
  const units = [];
  for(let i=0; i<kanaStr.length; i++){
    const ch = kanaStr[i];
    const next = kanaStr[i+1];
    // 促音保留為單位 'ッ'/'っ'
    if(ch==='っ' || ch==='ッ'){
      units.push(ch);
      continue;
    }
    // 拗音：小ゃゅょ 跟前一個合併 -> 在這裡做成單位
    if((next && SMALL_Y.has(next))){
      units.push(ch+next);
      i++; // 跳過下一個
      continue;
    }
    units.push(ch);
  }

  // 將單位轉成羅馬字（含促音處理、長音）
  let roma = '';
  for(let i=0; i<units.length; i++){
    const u = units[i];
    if(u==='っ' || u==='ッ'){
      // 看下一個單位的首子音
      const next = units[i+1] || '';
      const base = unitRoma(next);
      if(base){
        const c = initialConsonant(base);
        roma += c ? c : '';
      }
      continue; // 不單獨輸出
    }
    // 長音記號（主要出現在片假名）
    if(u==='ー'){
      const v = lastVowel(roma);
      if(v) roma += v; // 例: カー -> kaa
      continue;
    }
    roma += unitRoma(u);
  }

  return roma;
}

function unitRoma(unit){
  // 拗音（兩字元）
  if(unit.length===2 && (SMALL_Y.has(unit[1]))){
    const base = BASE_ROMA[unit[0]] || '';
    const y = unit[1];
    // 取 base 的子音部分 + ya/yu/yo
    const cons = base.replace(/[aeiou]$/,'');
    const tail = (y==='ゃ'||y==='ャ')? 'ya' : (y==='ゅ'||y==='ュ')? 'yu' : 'yo';
    // 特例：shi/chi -> 對應 sha/cha
    if(base.startsWith('shi')) return 'sh' + tail;
    if(base.startsWith('chi')) return 'ch' + tail;
    if(base.startsWith('ji'))  return 'j'  + tail;
    return cons + tail;
  }
  // 單字元：直接查表
  return BASE_ROMA[unit] || '';
}

function initialConsonant(roma){
  // 取第一個子音（shi -> s, chi -> c, tsu -> t）
  if(!roma) return '';
  if(roma.startsWith('ch')) return 'c';
  if(roma.startsWith('sh')) return 's';
  if(roma.startsWith('ts')) return 't';
  return roma[0].match(/[aeiou]/) ? '' : roma[0];
}

function lastVowel(str){
  const m = str.match(/[aeiou](?!.*[aeiou])/);
  return m? m[0] : '';
}

function expandRomajiVariants(main){
  // 依主拼音產生可接受的替代拼法（Hepburn/Nihon 式常見差異）
  const set = new Set([main]);
  const repls = [
    [/shi/g,'si'],[/chi/g,'ti'],[/tsu/g,'tu'],
    [/sha/g,'sya'],[/shu/g,'syu'],[/sho/g,'syo'],
    [/cha/g,'tya'],[/chu/g,'tyu'],[/cho/g,'tyo'],
    [/ji/g,'zi']
  ];
  // ん：允許 nn 變體（簡易處理：將 n->nn；以及把 nn->n）
  const nVariants = new Set();
  set.forEach(s=>{ nVariants.add(s.replace(/n/g,'nn')); nVariants.add(s.replace(/nn/g,'n')); });
  nVariants.forEach(s=>set.add(s));
  // 套用其他替代
  repls.forEach(([re,alt])=>{
    const cur = Array.from(set);
    cur.forEach(s=>{ set.add(s.replace(re,alt)); });
  });
  return set;
}

// === 事件與初始化 ===

document.querySelectorAll('input[name="direction"]').forEach(r=>{
  r.onchange=e=>{ state.direction=e.target.value; nextQuestion(); };
});

document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.onchange=e=>{
    state.mode=e.target.value;
    document.getElementById('input-mode').style.display = state.mode==='input'? '':'none';
    document.getElementById('choice-mode').style.display = state.mode==='choice'? '':'none';
    nextQuestion();
  };
});

document.querySelectorAll('input[name="set"]').forEach(c=>{
  c.onchange=()=>{ rebuildPool(); nextQuestion(); };
});

document.getElementById('btn-submit').onclick=()=>{
  checkAnswer(document.getElementById('answer').value);
};

document.getElementById('answer').addEventListener('keydown',e=>{
  if(e.key==='Enter') checkAnswer(document.getElementById('answer').value);
});

document.getElementById('btn-speak').onclick=speakKana;

document.getElementById('speed-select').onchange=e=>{
  state.rate=parseFloat(e.target.value);
  document.getElementById('custom-speed').value = state.rate;
};

document.getElementById('custom-speed').onchange=e=>{
  let val=parseFloat(e.target.value);
  if(!isNaN(val)&&val>0&&val<=2){ state.rate=val; }
};

document.getElementById('btn-clear-history').onclick=()=>{
  document.getElementById('history').innerHTML='';
  state.total=0; state.correct=0; updateStats();
};

rebuildPool();
nextQuestion();
updateStats();
</script>
</body>
</html>
