<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—¥æ–‡äº”åéŸ³ç·´ç¿’ï½œHiragana & Katakana Trainer</title>
  <style>
    body { font-family: sans-serif; background:#0f172a; color:#eee; margin:0; padding:0; }
    .container { max-width: 900px; margin:0 auto; padding:20px; }
    .panel { background:#1e293b; border-radius:10px; padding:16px; margin-bottom:20px; }
    h1 { margin:0 0 10px; }
    .prompt { font-size:64px; text-align:center; margin:20px 0; }
    .btn { background:#22d3ee; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; margin:4px; }
    .btn.secondary { background:#a78bfa; }
    .btn.ghost { background:#334155; color:#fff; }
    .input { width:100%; padding:10px; font-size:18px; border-radius:8px; border:none; margin:10px 0; }
    .feedback { font-weight:bold; margin-top:10px; }
    .ok { color:#34d399; }
    .err { color:#f87171; }
    .choices { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; }
    .choice-btn { background:#475569; border:none; border-radius:8px; padding:10px; font-size:20px; cursor:pointer; }
    .choice-btn:hover { background:#64748b; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    label { display:flex; align-items:center; gap:4px; }
    #history { 
      margin-top:20px; 
      background:#1e293b; 
      padding:10px; 
      border-radius:10px; 
      font-size:16px; 
      display:flex; 
      flex-wrap:wrap; 
      gap:8px; 
    }
    #history div { 
      background:#334155; 
      padding:4px 8px; 
      border-radius:6px; 
      white-space:nowrap; 
    }
    #history div.err { color:#f87171; }
    #history div.ok { color:#34d399; }
    #stats { margin-top:10px; font-size:16px; color:#fcd34d; }
  </style>
</head>
<body>
<div class="container">
  <h1>æ—¥æ–‡äº”åéŸ³ç·´ç¿’ <span style="font-size:14px; color:#94a3b8;">å¸¶ç™¼éŸ³ & é¸æ“‡é¡Œ</span></h1>

  <div class="panel">
    <div class="row">
      <label><input type="radio" name="direction" value="kana2roma" checked> å‡åâ†’ç¾…é¦¬å­—</label>
      <label><input type="radio" name="direction" value="roma2kana"> ç¾…é¦¬å­—â†’å‡å</label>
      <label><input type="radio" name="mode" value="input" checked> è¼¸å…¥æ¨¡å¼</label>
      <label><input type="radio" name="mode" value="choice"> é¸æ“‡é¡Œæ¨¡å¼</label>
    </div>
    <div class="row">
      <label><input type="checkbox" name="set" value="hira" checked> å¹³å‡å</label>
      <label><input type="checkbox" name="set" value="kata" checked> ç‰‡å‡å</label>
      <label><input type="checkbox" name="set" value="youon"> å«æ‹—éŸ³</label>
      <label><input type="checkbox" name="set" value="words"> å¤šå­—çµ„åˆï¼ˆå«ä¿ƒéŸ³ï¼‰</label>
    </div>
    <div class="prompt" id="q">â€”</div>
    <div class="row" style="justify-content:center;">
      <button class="btn" id="btn-speak">ğŸ”Š ç™¼éŸ³</button>
      <select id="speed-select" class="btn ghost">
        <option value="0.3">æ…¢é€Ÿ</option>
        <option value="0.5" selected>æ­£å¸¸</option>
        <option value="0.9">å¿«é€Ÿ</option>
      </select>
      <label style="color:#ccc;">è‡ªè¨‚é€Ÿåº¦ <input id="custom-speed" type="number" step="0.1" min="0.1" max="2" value="0.5" style="width:60px; padding:4px; border-radius:6px; border:none;"> </label>
    </div>
    <div id="input-mode">
      <input class="input" id="answer" placeholder="è¼¸å…¥ç­”æ¡ˆï¼ŒEnter é€å‡º">
      <button class="btn secondary" id="btn-submit">é€å‡º</button>
    </div>
    <div id="choice-mode" style="display:none;">
      <div class="choices" id="choices"></div>
    </div>
    <div class="feedback" id="feedback"> </div>
  </div>

  <button class="btn ghost" id="btn-clear-history">æ¸…é™¤æ­·å²ç´€éŒ„</button>
  <div id="stats">æ­£ç¢º 0 / ç¸½é¡Œæ•¸ 0 (0%)</div>
  <div id="history"></div>
</div>

<script>
// === åŸºç¤å‡åï¼ˆå¤šæ‹¼éŸ³ï¼‰ ===
const BASIC = [
  ['ã‚','ã‚¢',['a']], ['ã„','ã‚¤',['i']], ['ã†','ã‚¦',['u']], ['ãˆ','ã‚¨',['e']], ['ãŠ','ã‚ª',['o']],
  ['ã‹','ã‚«',['ka']], ['ã','ã‚­',['ki']], ['ã','ã‚¯',['ku']], ['ã‘','ã‚±',['ke']], ['ã“','ã‚³',['ko']],
  ['ã•','ã‚µ',['sa']], ['ã—','ã‚·',['shi','si']], ['ã™','ã‚¹',['su']], ['ã›','ã‚»',['se']], ['ã','ã‚½',['so']],
  ['ãŸ','ã‚¿',['ta']], ['ã¡','ãƒ',['chi','ti']], ['ã¤','ãƒ„',['tsu','tu']], ['ã¦','ãƒ†',['te']], ['ã¨','ãƒˆ',['to']],
  ['ãª','ãƒŠ',['na']], ['ã«','ãƒ‹',['ni']], ['ã¬','ãƒŒ',['nu']], ['ã­','ãƒ',['ne']], ['ã®','ãƒ',['no']],
  ['ã¯','ãƒ',['ha']], ['ã²','ãƒ’',['hi']], ['ãµ','ãƒ•',['fu','hu']], ['ã¸','ãƒ˜',['he']], ['ã»','ãƒ›',['ho']],
  ['ã¾','ãƒ',['ma']], ['ã¿','ãƒŸ',['mi']], ['ã‚€','ãƒ ',['mu']], ['ã‚','ãƒ¡',['me']], ['ã‚‚','ãƒ¢',['mo']],
  ['ã‚„','ãƒ¤',['ya']], ['ã‚†','ãƒ¦',['yu']], ['ã‚ˆ','ãƒ¨',['yo']],
  ['ã‚‰','ãƒ©',['ra']], ['ã‚Š','ãƒª',['ri']], ['ã‚‹','ãƒ«',['ru']], ['ã‚Œ','ãƒ¬',['re']], ['ã‚','ãƒ­',['ro']],
  ['ã‚','ãƒ¯',['wa']], ['ã‚’','ãƒ²',['wo','o']], ['ã‚“','ãƒ³',['n','nn']]
];

// === æ‹—éŸ³ï¼ˆå¤šæ‹¼éŸ³ï¼‰ ===
const YOUON = [
  ['ãã‚ƒ','ã‚­ãƒ£',['kya']], ['ãã‚…','ã‚­ãƒ¥',['kyu']], ['ãã‚‡','ã‚­ãƒ§',['kyo']],
  ['ã—ã‚ƒ','ã‚·ãƒ£',['sha','sya']], ['ã—ã‚…','ã‚·ãƒ¥',['shu','syu']], ['ã—ã‚‡','ã‚·ãƒ§',['sho','syo']],
  ['ã¡ã‚ƒ','ãƒãƒ£',['cha','tya']], ['ã¡ã‚…','ãƒãƒ¥',['chu','tyu']], ['ã¡ã‚‡','ãƒãƒ§',['cho','tyo']],
  ['ã«ã‚ƒ','ãƒ‹ãƒ£',['nya']], ['ã«ã‚…','ãƒ‹ãƒ¥',['nyu']], ['ã«ã‚‡','ãƒ‹ãƒ§',['nyo']],
  ['ã²ã‚ƒ','ãƒ’ãƒ£',['hya']], ['ã²ã‚…','ãƒ’ãƒ¥',['hyu']], ['ã²ã‚‡','ãƒ’ãƒ§',['hyo']],
  ['ã¿ã‚ƒ','ãƒŸãƒ£',['mya']], ['ã¿ã‚…','ãƒŸãƒ¥',['myu']], ['ã¿ã‚‡','ãƒŸãƒ§',['myo']],
  ['ã‚Šã‚ƒ','ãƒªãƒ£',['rya']], ['ã‚Šã‚…','ãƒªãƒ¥',['ryu']], ['ã‚Šã‚‡','ãƒªãƒ§',['ryo']]
];

// === å–®è©ï¼ˆå¤šå­—çµ„åˆï¼Œç¤ºä¾‹ï¼Œå¯è‡ªè¡Œæ“´å……ï¼‰ ===
const WORDS = [
  ['ã„ã£ãŸ','ã‚¤ãƒƒã‚¿'],
  ['ãŒã£ã“ã†','ã‚¬ãƒƒã‚³ã‚¦'],
  ['ã¾ã£ã¦','ãƒãƒƒãƒ†'],
  ['ãã£ã·','ã‚­ãƒƒãƒ—'],
  ['ã‚„ã£ã±ã‚Š','ãƒ¤ãƒƒãƒ‘ãƒª'],
  ['ã‘ã£ã“ã‚“','ã‚±ãƒƒã‚³ãƒ³'],
  ['ã–ã£ã—','ã‚¶ãƒƒã‚·'],
  ['ãã‚‡ã†','ã‚­ãƒ§ã‚¦'],
  ['ãã‚ƒã','ã‚­ãƒ£ã‚¯'],
  ['ã—ã‚…ã£ã±ã¤','ã‚·ãƒ¥ãƒƒãƒ‘ãƒ„'],
];

// ä¾›è§£æç”¨ï¼šå¹³å‡å/ç‰‡å‡å -> åŸºæœ¬ç¾…é¦¬å­—ï¼ˆä¸å«æ‹—éŸ³/ä¿ƒéŸ³é‚è¼¯ï¼‰
const BASE_ROMA = {
  // æ¸…éŸ³
  'ã‚':'a','ã„':'i','ã†':'u','ãˆ':'e','ãŠ':'o','ã‹':'ka','ã':'ki','ã':'ku','ã‘':'ke','ã“':'ko',
  'ã•':'sa','ã—':'shi','ã™':'su','ã›':'se','ã':'so','ãŸ':'ta','ã¡':'chi','ã¤':'tsu','ã¦':'te','ã¨':'to',
  'ãª':'na','ã«':'ni','ã¬':'nu','ã­':'ne','ã®':'no','ã¯':'ha','ã²':'hi','ãµ':'fu','ã¸':'he','ã»':'ho',
  'ã¾':'ma','ã¿':'mi','ã‚€':'mu','ã‚':'me','ã‚‚':'mo','ã‚„':'ya','ã‚†':'yu','ã‚ˆ':'yo','ã‚‰':'ra','ã‚Š':'ri','ã‚‹':'ru','ã‚Œ':'re','ã‚':'ro','ã‚':'wa','ã‚’':'wo','ã‚“':'n',
  // æ¿éŸ³/åŠæ¿éŸ³
  'ãŒ':'ga','ã':'gi','ã':'gu','ã’':'ge','ã”':'go','ã–':'za','ã˜':'ji','ãš':'zu','ãœ':'ze','ã':'zo',
  'ã ':'da','ã¢':'ji','ã¥':'zu','ã§':'de','ã©':'do','ã°':'ba','ã³':'bi','ã¶':'bu','ã¹':'be','ã¼':'bo','ã±':'pa','ã´':'pi','ã·':'pu','ãº':'pe','ã½':'po',
  // ç‰‡å‡åå°æ‡‰
  'ã‚¢':'a','ã‚¤':'i','ã‚¦':'u','ã‚¨':'e','ã‚ª':'o','ã‚«':'ka','ã‚­':'ki','ã‚¯':'ku','ã‚±':'ke','ã‚³':'ko',
  'ã‚µ':'sa','ã‚·':'shi','ã‚¹':'su','ã‚»':'se','ã‚½':'so','ã‚¿':'ta','ãƒ':'chi','ãƒ„':'tsu','ãƒ†':'te','ãƒˆ':'to',
  'ãƒŠ':'na','ãƒ‹':'ni','ãƒŒ':'nu','ãƒ':'ne','ãƒ':'no','ãƒ':'ha','ãƒ’':'hi','ãƒ•':'fu','ãƒ˜':'he','ãƒ›':'ho',
  'ãƒ':'ma','ãƒŸ':'mi','ãƒ ':'mu','ãƒ¡':'me','ãƒ¢':'mo','ãƒ¤':'ya','ãƒ¦':'yu','ãƒ¨':'yo','ãƒ©':'ra','ãƒª':'ri','ãƒ«':'ru','ãƒ¬':'re','ãƒ­':'ro','ãƒ¯':'wa','ãƒ²':'wo','ãƒ³':'n',
  'ã‚¬':'ga','ã‚®':'gi','ã‚°':'gu','ã‚²':'ge','ã‚´':'go','ã‚¶':'za','ã‚¸':'ji','ã‚º':'zu','ã‚¼':'ze','ã‚¾':'zo',
  'ãƒ€':'da','ãƒ‚':'ji','ãƒ…':'zu','ãƒ‡':'de','ãƒ‰':'do','ãƒ':'ba','ãƒ“':'bi','ãƒ–':'bu','ãƒ™':'be','ãƒœ':'bo','ãƒ‘':'pa','ãƒ”':'pi','ãƒ—':'pu','ãƒš':'pe','ãƒ':'po'
};

const SMALL_Y = new Set(['ã‚ƒ','ã‚…','ã‚‡','ãƒ£','ãƒ¥','ãƒ§']);
const SMALL_V = new Set(['ã','ãƒ','ã…','ã‡','ã‰','ã‚¡','ã‚£','ã‚¥','ã‚§','ã‚©']);

const state = {
  pool: [],
  direction:'kana2roma',
  mode:'input',
  current:null,
  rate:0.5,
  total:0,
  correct:0
};

function rebuildPool(){
  const hira = document.querySelector("input[value='hira']").checked;
  const kata = document.querySelector("input[value='kata']").checked;
  const youon = document.querySelector("input[value='youon']").checked;
  const words = document.querySelector("input[value='words']").checked;

  let pool = [];
  // å–®å­—ï¼ˆäº”åéŸ³ + æ‹—éŸ³ï¼‰
  let base = BASIC;
  if(youon) base = BASIC.concat(YOUON);
  const singlePool = base.map(([h,k,r])=>({hira:h,kata:k,roma:r})).filter(it=> (hira && it.hira) || (kata && it.kata));

  // å¤šå­—çµ„åˆ
  let wordPool = [];
  if(words){
    wordPool = WORDS.map(([h,k])=>{
      const romaMain = generateRoma(h); // ä»¥å¹³å‡åç‰ˆæœ¬ç”Ÿæˆä¸»ç¾…é¦¬å­—
      const variants = expandRomajiVariants(romaMain);
      return {hira:h,kata:k,roma:[...variants]};
    }).filter(it=> (hira && it.hira) || (kata && it.kata));
  }

  pool = words ? singlePool.concat(wordPool) : singlePool;
  state.pool = pool;
}

function updateStats(){
  const percent = state.total>0? Math.round(state.correct/state.total*100):0;
  document.getElementById('stats').textContent = `æ­£ç¢º ${state.correct} / ç¸½é¡Œæ•¸ ${state.total} (${percent}%)`;
}

function nextQuestion(){
  if(state.pool.length===0){ rebuildPool(); }
  const it = state.pool[Math.floor(Math.random()*state.pool.length)];
  state.current = it;
  const showKana = (state.direction==='kana2roma');

  if(showKana){
    const hira = document.querySelector("input[value='hira']").checked;
    const kata = document.querySelector("input[value='kata']").checked;

    if(hira && kata){
      document.getElementById('q').textContent = Math.random()<0.5 ? it.hira : it.kata;
    }else if(hira){
      document.getElementById('q').textContent = it.hira;
    }else if(kata){
      document.getElementById('q').textContent = it.kata;
    }else{
      document.getElementById('q').textContent = 'ï¼ˆè«‹å‹¾é¸å¹³å‡åæˆ–ç‰‡å‡åï¼‰';
    }
  } else {
    // é¡¯ç¤ºç¬¬ä¸€å€‹å¯æ¥å—æ‹¼éŸ³
    document.getElementById('q').textContent = Array.isArray(it.roma) ? it.roma[0] : it.roma;
  }

  document.getElementById('feedback').textContent = '';
  document.getElementById('answer').value = '';

  if(state.mode==='choice'){
    renderChoices(it);
  }
}


function checkAnswer(ans){
  state.total++;
  const showKana = (state.direction==='kana2roma');
  let correct;
  if(showKana){
    const input = ans.trim().toLowerCase();
    correct = state.current.roma.some(r => r === input);
  } else {
    correct = (ans.trim()===state.current.hira || ans.trim()===state.current.kata);
  }

  if(correct){
    state.correct++;
    document.getElementById('feedback').innerHTML = `<span class="ok">âœ” æ­£ç¢º</span>`;
    speakKana();
    document.getElementById('answer').value = '';
    addHistory(state.current, true);
    setTimeout(nextQuestion,1200);
  } else {
    document.getElementById('feedback').innerHTML = `<span class="err">âœ˜ éŒ¯èª¤ï¼Œå†è©¦ä¸€æ¬¡</span>`;
    playBeep();
    addHistory(state.current, false, ans.trim());
    document.getElementById('answer').value = ''; // ç­”éŒ¯ä¹Ÿæ¸…ç©º
  }
  updateStats();
}


function renderChoices(it){
  const showKana = (state.direction==='kana2roma');
  const correct = showKana? (Array.isArray(it.roma)? it.roma[0] : it.roma) : it.hira;
  let options = new Set([correct]);
  while(options.size<4){
    const rnd = state.pool[Math.floor(Math.random()*state.pool.length)];
    const opt = showKana? (Array.isArray(rnd.roma)? rnd.roma[0] : rnd.roma) : rnd.hira;
    options.add(opt);
  }
  const arr = Array.from(options).sort(()=>Math.random()-0.5);
  const box = document.getElementById('choices');
  box.innerHTML = '';
  arr.forEach(opt=>{
    const b = document.createElement('button');
    b.textContent = opt;
    b.className = 'choice-btn';
    b.onclick=()=>checkAnswer(opt);
    box.appendChild(b);
  });
}

function speakKana(){
  if(!state.current) return;
  const showKana = (state.direction==='kana2roma');
  // æœ—è®€ç•«é¢ä¸Šé¡¯ç¤ºçš„æ–‡å­—ï¼Œç¢ºä¿å¤šå­—ä¹Ÿæœƒå”¸
  const displayText = document.getElementById('q').textContent;
  const utter = new SpeechSynthesisUtterance(displayText + 'ãƒ¼');
  utter.lang = 'ja-JP';
  utter.rate = state.rate;
  utter.pitch = 1.0;
  utter.volume = 1.0;
  speechSynthesis.speak(utter);
}

function playBeep(){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 440;
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  gain.gain.setValueAtTime(0.2, ctx.currentTime);
  osc.stop(ctx.currentTime+0.3);
}

function addHistory(item, correct, userInput=""){
  const h = document.getElementById('history');
  const div = document.createElement('div');

  if(correct){
    div.innerHTML = `âœ” <span style="color:#34d399">${item.hira}/${item.kata} â†’ ${item.roma[0]}</span>`;
  } else {
    div.innerHTML = `
      ${item.hira}/${item.kata} â†’ 
      <span style="color:#f87171;text-decoration:line-through;">${userInput}</span>, 
      <span style="color:#34d399;">âœ” ${item.roma[0]}</span>`;
  }

  h.prepend(div); // æœ€æ–°åœ¨æœ€å‰
}




// === å‡åè§£æèˆ‡ç¾…é¦¬å­—ç”Ÿæˆï¼ˆæ‹—éŸ³ + ä¿ƒéŸ³ + é•·éŸ³ï¼‰ ===
function generateRoma(kanaStr){
  // å°‡å­—ä¸²åˆ‡æˆå–®ä½ï¼ˆè™•ç†æ‹—éŸ³ï¼‰
  const units = [];
  for(let i=0; i<kanaStr.length; i++){
    const ch = kanaStr[i];
    const next = kanaStr[i+1];
    // ä¿ƒéŸ³ä¿ç•™ç‚ºå–®ä½ 'ãƒƒ'/'ã£'
    if(ch==='ã£' || ch==='ãƒƒ'){
      units.push(ch);
      continue;
    }
    // æ‹—éŸ³ï¼šå°ã‚ƒã‚…ã‚‡ è·Ÿå‰ä¸€å€‹åˆä½µ -> åœ¨é€™è£¡åšæˆå–®ä½
    if((next && SMALL_Y.has(next))){
      units.push(ch+next);
      i++; // è·³éä¸‹ä¸€å€‹
      continue;
    }
    units.push(ch);
  }

  // å°‡å–®ä½è½‰æˆç¾…é¦¬å­—ï¼ˆå«ä¿ƒéŸ³è™•ç†ã€é•·éŸ³ï¼‰
  let roma = '';
  for(let i=0; i<units.length; i++){
    const u = units[i];
    if(u==='ã£' || u==='ãƒƒ'){
      // çœ‹ä¸‹ä¸€å€‹å–®ä½çš„é¦–å­éŸ³
      const next = units[i+1] || '';
      const base = unitRoma(next);
      if(base){
        const c = initialConsonant(base);
        roma += c ? c : '';
      }
      continue; // ä¸å–®ç¨è¼¸å‡º
    }
    // é•·éŸ³è¨˜è™Ÿï¼ˆä¸»è¦å‡ºç¾åœ¨ç‰‡å‡åï¼‰
    if(u==='ãƒ¼'){
      const v = lastVowel(roma);
      if(v) roma += v; // ä¾‹: ã‚«ãƒ¼ -> kaa
      continue;
    }
    roma += unitRoma(u);
  }

  return roma;
}

function unitRoma(unit){
  // æ‹—éŸ³ï¼ˆå…©å­—å…ƒï¼‰
  if(unit.length===2 && (SMALL_Y.has(unit[1]))){
    const base = BASE_ROMA[unit[0]] || '';
    const y = unit[1];
    // å– base çš„å­éŸ³éƒ¨åˆ† + ya/yu/yo
    const cons = base.replace(/[aeiou]$/,'');
    const tail = (y==='ã‚ƒ'||y==='ãƒ£')? 'ya' : (y==='ã‚…'||y==='ãƒ¥')? 'yu' : 'yo';
    // ç‰¹ä¾‹ï¼šshi/chi -> å°æ‡‰ sha/cha
    if(base.startsWith('shi')) return 'sh' + tail;
    if(base.startsWith('chi')) return 'ch' + tail;
    if(base.startsWith('ji'))  return 'j'  + tail;
    return cons + tail;
  }
  // å–®å­—å…ƒï¼šç›´æ¥æŸ¥è¡¨
  return BASE_ROMA[unit] || '';
}

function initialConsonant(roma){
  // å–ç¬¬ä¸€å€‹å­éŸ³ï¼ˆshi -> s, chi -> c, tsu -> tï¼‰
  if(!roma) return '';
  if(roma.startsWith('ch')) return 'c';
  if(roma.startsWith('sh')) return 's';
  if(roma.startsWith('ts')) return 't';
  return roma[0].match(/[aeiou]/) ? '' : roma[0];
}

function lastVowel(str){
  const m = str.match(/[aeiou](?!.*[aeiou])/);
  return m? m[0] : '';
}

function expandRomajiVariants(main){
  // ä¾ä¸»æ‹¼éŸ³ç”¢ç”Ÿå¯æ¥å—çš„æ›¿ä»£æ‹¼æ³•ï¼ˆHepburn/Nihon å¼å¸¸è¦‹å·®ç•°ï¼‰
  const set = new Set([main]);
  const repls = [
    [/shi/g,'si'],[/chi/g,'ti'],[/tsu/g,'tu'],
    [/sha/g,'sya'],[/shu/g,'syu'],[/sho/g,'syo'],
    [/cha/g,'tya'],[/chu/g,'tyu'],[/cho/g,'tyo'],
    [/ji/g,'zi']
  ];
  // ã‚“ï¼šå…è¨± nn è®Šé«”ï¼ˆç°¡æ˜“è™•ç†ï¼šå°‡ n->nnï¼›ä»¥åŠæŠŠ nn->nï¼‰
  const nVariants = new Set();
  set.forEach(s=>{ nVariants.add(s.replace(/n/g,'nn')); nVariants.add(s.replace(/nn/g,'n')); });
  nVariants.forEach(s=>set.add(s));
  // å¥—ç”¨å…¶ä»–æ›¿ä»£
  repls.forEach(([re,alt])=>{
    const cur = Array.from(set);
    cur.forEach(s=>{ set.add(s.replace(re,alt)); });
  });
  return set;
}

// === äº‹ä»¶èˆ‡åˆå§‹åŒ– ===

document.querySelectorAll('input[name="direction"]').forEach(r=>{
  r.onchange=e=>{ state.direction=e.target.value; nextQuestion(); };
});

document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.onchange=e=>{
    state.mode=e.target.value;
    document.getElementById('input-mode').style.display = state.mode==='input'? '':'none';
    document.getElementById('choice-mode').style.display = state.mode==='choice'? '':'none';
    nextQuestion();
  };
});

document.querySelectorAll('input[name="set"]').forEach(c=>{
  c.onchange=()=>{ rebuildPool(); nextQuestion(); };
});

document.getElementById('btn-submit').onclick=()=>{
  checkAnswer(document.getElementById('answer').value);
};

document.getElementById('answer').addEventListener('keydown',e=>{
  if(e.key==='Enter') checkAnswer(document.getElementById('answer').value);
});

document.getElementById('btn-speak').onclick=speakKana;

document.getElementById('speed-select').onchange=e=>{
  state.rate=parseFloat(e.target.value);
  document.getElementById('custom-speed').value = state.rate;
};

document.getElementById('custom-speed').onchange=e=>{
  let val=parseFloat(e.target.value);
  if(!isNaN(val)&&val>0&&val<=2){ state.rate=val; }
};

document.getElementById('btn-clear-history').onclick=()=>{
  document.getElementById('history').innerHTML='';
  state.total=0; state.correct=0; updateStats();
};

rebuildPool();
nextQuestion();
updateStats();
</script>
</body>
</html>
