<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—¥æ–‡äº”åéŸ³ç·´ç¿’ï½œHiragana & Katakana Trainer</title>
  <style>
    body { font-family: sans-serif; background:#0f172a; color:#eee; margin:0; padding:0; }
    .container { max-width: 900px; margin:0 auto; padding:20px; }
    .panel { background:#1e293b; border-radius:10px; padding:16px; margin-bottom:20px; }
    h1 { margin:0 0 10px; }
    .prompt { font-size:64px; text-align:center; margin:20px 0; }
    .btn { background:#22d3ee; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; margin:4px; }
    .btn.secondary { background:#a78bfa; }
    .btn.ghost { background:#334155; color:#fff; }
    .input { width:100%; padding:10px; font-size:18px; border-radius:8px; border:none; margin:10px 0; }
    .feedback { font-weight:bold; margin-top:10px; }
    .ok { color:#34d399; }
    .err { color:#f87171; }
    .choices { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; }
    .choice-btn { background:#475569; border:none; border-radius:8px; padding:10px; font-size:20px; cursor:pointer; }
    .choice-btn:hover { background:#64748b; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    label { display:flex; align-items:center; gap:4px; }
    #history { 
      margin-top:20px; 
      background:#1e293b; 
      padding:10px; 
      border-radius:10px; 
      font-size:16px; 
      display:flex; 
      flex-wrap:wrap; 
      gap:8px; 
    }
    #history div { 
      background:#334155; 
      padding:4px 8px; 
      border-radius:6px; 
      white-space:nowrap; 
    }
    #history .wrong { color:#f87171; font-weight:bold; }
    #stats { margin-top:10px; font-size:16px; color:#fcd34d; }
  </style>
</head>
<body>
<div class="container">
  <h1>æ—¥æ–‡äº”åéŸ³ç·´ç¿’ <span style="font-size:14px; color:#94a3b8;">å¸¶ç™¼éŸ³ & é¸æ“‡é¡Œ</span></h1>

  <div class="panel">
    <div class="row">
      <label><input type="radio" name="direction" value="kana2roma" checked> å‡åâ†’ç¾…é¦¬å­—</label>
      <label><input type="radio" name="direction" value="roma2kana"> ç¾…é¦¬å­—â†’å‡å</label>
      <label><input type="radio" name="mode" value="input" checked> è¼¸å…¥æ¨¡å¼</label>
      <label><input type="radio" name="mode" value="choice"> é¸æ“‡é¡Œæ¨¡å¼</label>
    </div>
    <div class="row">
      <label><input type="checkbox" name="set" value="hira" checked> å¹³å‡å</label>
      <label><input type="checkbox" name="set" value="kata" checked> ç‰‡å‡å</label>
      <label><input type="checkbox" name="set" value="youon"> å«æ‹—éŸ³</label>
    </div>
    <div class="prompt" id="q">â€”</div>
    <div class="row" style="justify-content:center;">
      <button class="btn" id="btn-speak">ğŸ”Š ç™¼éŸ³</button>
      <select id="speed-select" class="btn ghost">
        <option value="0.3">æ…¢é€Ÿ</option>
        <option value="0.5" selected>æ­£å¸¸</option>
        <option value="0.9">å¿«é€Ÿ</option>
      </select>
      <label style="color:#ccc;">è‡ªè¨‚é€Ÿåº¦ <input id="custom-speed" type="number" step="0.1" min="0.1" max="2" value="0.5" style="width:60px; padding:4px; border-radius:6px; border:none;"> </label>
    </div>
    <div id="input-mode">
      <input class="input" id="answer" placeholder="è¼¸å…¥ç­”æ¡ˆï¼ŒEnter é€å‡º">
      <button class="btn secondary" id="btn-submit">é€å‡º</button>
    </div>
    <div id="choice-mode" style="display:none;">
      <div class="choices" id="choices"></div>
    </div>
    <div class="feedback" id="feedback"> </div>
  </div>

  <button class="btn ghost" id="btn-clear-history">æ¸…é™¤æ­·å²ç´€éŒ„</button>
  <div id="stats">æ­£ç¢º 0 / ç¸½é¡Œæ•¸ 0 (0%)</div>
  <div id="history"></div>
</div>

<script>
const BASIC = [
  ['ã‚','ã‚¢','a'],['ã„','ã‚¤','i'],['ã†','ã‚¦','u'],['ãˆ','ã‚¨','e'],['ãŠ','ã‚ª','o'],
  ['ã‹','ã‚«','ka'],['ã','ã‚­','ki'],['ã','ã‚¯','ku'],['ã‘','ã‚±','ke'],['ã“','ã‚³','ko'],
  ['ã•','ã‚µ','sa'],['ã—','ã‚·','shi'],['ã™','ã‚¹','su'],['ã›','ã‚»','se'],['ã','ã‚½','so'],
  ['ãŸ','ã‚¿','ta'],['ã¡','ãƒ','chi'],['ã¤','ãƒ„','tsu'],['ã¦','ãƒ†','te'],['ã¨','ãƒˆ','to'],
  ['ãª','ãƒŠ','na'],['ã«','ãƒ‹','ni'],['ã¬','ãƒŒ','nu'],['ã­','ãƒ','ne'],['ã®','ãƒ','no'],
  ['ã¯','ãƒ','ha'],['ã²','ãƒ’','hi'],['ãµ','ãƒ•','fu'],['ã¸','ãƒ˜','he'],['ã»','ãƒ›','ho'],
  ['ã¾','ãƒ','ma'],['ã¿','ãƒŸ','mi'],['ã‚€','ãƒ ','mu'],['ã‚','ãƒ¡','me'],['ã‚‚','ãƒ¢','mo'],
  ['ã‚„','ãƒ¤','ya'],['ã‚†','ãƒ¦','yu'],['ã‚ˆ','ãƒ¨','yo'],
  ['ã‚‰','ãƒ©','ra'],['ã‚Š','ãƒª','ri'],['ã‚‹','ãƒ«','ru'],['ã‚Œ','ãƒ¬','re'],['ã‚','ãƒ­','ro'],
  ['ã‚','ãƒ¯','wa'],['ã‚’','ãƒ²','wo'],['ã‚“','ãƒ³','n']
];

const YOUON = [
  ['ãã‚ƒ','ã‚­ãƒ£','kya'],['ãã‚…','ã‚­ãƒ¥','kyu'],['ãã‚‡','ã‚­ãƒ§','kyo'],
  ['ã—ã‚ƒ','ã‚·ãƒ£','sha'],['ã—ã‚…','ã‚·ãƒ¥','shu'],['ã—ã‚‡','ã‚·ãƒ§','sho'],
  ['ã¡ã‚ƒ','ãƒãƒ£','cha'],['ã¡ã‚…','ãƒãƒ¥','chu'],['ã¡ã‚‡','ãƒãƒ§','cho'],
  ['ã«ã‚ƒ','ãƒ‹ãƒ£','nya'],['ã«ã‚…','ãƒ‹ãƒ¥','nyu'],['ã«ã‚‡','ãƒ‹ãƒ§','nyo'],
  ['ã²ã‚ƒ','ãƒ’ãƒ£','hya'],['ã²ã‚…','ãƒ’ãƒ¥','hyu'],['ã²ã‚‡','ãƒ’ãƒ§','hyo'],
  ['ã¿ã‚ƒ','ãƒŸãƒ£','mya'],['ã¿ã‚…','ãƒŸãƒ¥','myu'],['ã¿ã‚‡','ãƒŸãƒ§','myo'],
  ['ã‚Šã‚ƒ','ãƒªãƒ£','rya'],['ã‚Šã‚…','ãƒªãƒ¥','ryu'],['ã‚Šã‚‡','ãƒªãƒ§','ryo']
];

const state = {
  pool: [],
  direction:'kana2roma',
  mode:'input',
  current:null,
  rate:0.5,
  total:0,
  correct:0
};

function rebuildPool(){
  const hira = document.querySelector("input[value='hira']").checked;
  const kata = document.querySelector("input[value='kata']").checked;
  const youon = document.querySelector("input[value='youon']").checked;
  let base = BASIC;
  if(youon) base = BASIC.concat(YOUON);
  state.pool = base.map(([h,k,r])=>({hira:h,kata:k,roma:r})).filter(it=>{
    return (hira && it.hira) || (kata && it.kata);
  });
}

function updateStats(){
  const percent = state.total>0? Math.round(state.correct/state.total*100):0;
  document.getElementById('stats').textContent = `æ­£ç¢º ${state.correct} / ç¸½é¡Œæ•¸ ${state.total} (${percent}%)`;
}

function nextQuestion(){
  if(state.pool.length===0){
    rebuildPool();
  }
  const it = state.pool[Math.floor(Math.random()*state.pool.length)];
  state.current = it;
  const showKana = (state.direction==='kana2roma');

  if(showKana){
    const hira = document.querySelector("input[value='hira']").checked;
    const kata = document.querySelector("input[value='kata']").checked;

    if(hira && kata){
      document.getElementById('q').textContent = Math.random()<0.5 ? it.hira : it.kata;
    }else if(hira){
      document.getElementById('q').textContent = it.hira;
    }else if(kata){
      document.getElementById('q').textContent = it.kata;
    }else{
      document.getElementById('q').textContent = 'ï¼ˆè«‹å‹¾é¸å¹³å‡åæˆ–ç‰‡å‡åï¼‰';
    }
  } else {
    document.getElementById('q').textContent = it.roma;
  }

  document.getElementById('feedback').textContent = '';
  document.getElementById('answer').value = '';

  if(state.mode==='choice'){
    renderChoices(it);
  }
}

function checkAnswer(ans){
  state.total++;
  const showKana = (state.direction==='kana2roma');
  let correct;
  if(showKana){
    correct = (ans.trim().toLowerCase()===state.current.roma);
  } else {
    correct = (ans.trim()===state.current.hira || ans.trim()===state.current.kata);
  }

  if(correct){
    state.correct++;
    document.getElementById('feedback').innerHTML = `<span class="ok">âœ” æ­£ç¢º</span>`;
    speakKana();
    document.getElementById('answer').value = '';
    addHistory(state.current, true);
    setTimeout(nextQuestion,1200);
  } else {
    document.getElementById('feedback').innerHTML = `<span class="err">âœ˜ éŒ¯èª¤ï¼Œå†è©¦ä¸€æ¬¡</span>`;
    playBeep();
    document.getElementById('answer').value = '';
    addHistory(state.current, false);
  }
  updateStats();
}

function renderChoices(it){
  const showKana = (state.direction==='kana2roma');
  const correct = showKana? it.roma : it.hira;
  let options = new Set([correct]);
  while(options.size<4){
    const rnd = state.pool[Math.floor(Math.random()*state.pool.length)];
    options.add(showKana? rnd.roma : rnd.hira);
  }
  const arr = Array.from(options).sort(()=>Math.random()-0.5);
  const box = document.getElementById('choices');
  box.innerHTML = '';
  arr.forEach(opt=>{
    const b = document.createElement('button');
    b.textContent = opt;
    b.className = 'choice-btn';
    b.onclick=()=>checkAnswer(opt);
    box.appendChild(b);
  });
}

function speakKana(){
  if(!state.current) return;
  const kana = state.current.hira;
  const utter = new SpeechSynthesisUtterance(kana + 'ãƒ¼ãƒ¼');
  utter.lang = 'ja-JP';
  utter.rate = state.rate;
  utter.pitch = 1.0;
  utter.volume = 1.0;
  speechSynthesis.speak(utter);
}

function playBeep(){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 440;
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  gain.gain.setValueAtTime(0.2, ctx.currentTime);
  osc.stop(ctx.currentTime+0.3);
}

function addHistory(item, correct){
  const h = document.getElementById('history');
  const div = document.createElement('div');
  if(correct){
    div.innerHTML = `âœ” ${item.hira}/${item.kata} â†’ ${item.roma}`;
  } else {
    div.innerHTML = `âœ˜ ${item.hira}/${item.kata} â†’ ${item.roma}`;
    div.classList.add('wrong');
  }
  h.prepend(div);
}

document.querySelectorAll('input[name="direction"]').forEach(r=>{
  r.onchange=e=>{ state.direction=e.target.value; nextQuestion(); };
});
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.onchange=e=>{
    state.mode=e.target.value;
    document.getElementById('input-mode').style.display = state.mode==='input'? '':'none';
    document.getElementById('choice-mode').style.display = state.mode==='choice'? '':'none';
    nextQuestion();
  };
});

document.querySelectorAll('input[name="set"]').forEach(c=>{
  c.onchange=()=>{ rebuildPool(); nextQuestion(); };
});

document.getElementById('btn-submit').onclick=()=>{
  checkAnswer(document.getElementById('answer').value);
};
document.getElementById('answer').addEventListener('keydown',e=>{
  if(e.key==='Enter') checkAnswer(document.getElementById('answer').value);
});
document.getElementById('btn-speak').onclick=speakKana;

document.getElementById('speed-select').onchange=e=>{
  state.rate=parseFloat(e.target.value);
  document.getElementById('custom-speed').value = state.rate;
};
document.getElementById('custom-speed').onchange=e=>{
  let val=parseFloat(e.target.value);
  if(!isNaN(val)&&val>0&&val<=2){
    state.rate=val;
  }
};

document.getElementById('btn-clear-history').onclick=()=>{
  document.getElementById('history').innerHTML='';
  state.total=0; state.correct=0; updateStats();
};

rebuildPool();
nextQuestion();
updateStats();
</script>
</body>
</html>
